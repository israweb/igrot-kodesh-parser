# 📚 Контекст проекта Игрот Кодеш - Постоянная составляющая

## 🔗 Структура сайта Chabad.org:

### Основные ссылки
- Главное хранилище писем: https://www.chabad.org/therebbe/article_cdo/aid/4643797/jewish/page.htm
- Первый том (כרך א): https://www.chabad.org/therebbe/article_cdo/aid/4643805/jewish/page.htm
- Первое письмо: https://www.chabad.org/therebbe/article_cdo/aid/4645943/jewish/page.htm

### Структура письма
- Заголовок: содержит номер письма (например, «אגרות קודש - מכתב א»)
- Первая строка: содержит дату письма на иврите
- Основной текст: содержимое письма

### Формат даты
Пример: `ב"ה, כ"א אדר, ה'תרפ"ח`
- `ב"ה` — удалить при парсинге
- `כ"א` — день на иврите (21)
- `אדר` — месяц
- `ה'תרפ"ח` — год на иврите (5688)

## 📊 Структура базы данных

### Таблица `letters` содержит
1. `tom_hebrew` — том на иврите (א, ב, ג...)
2. `tom_number` — том цифрой (1, 2, 3...)
3. `letter_hebrew` — номер письма на иврите (א, ב, ג...)
4. `letter_number` — номер письма цифрой (1, 2, 3...)
5. `full_date_hebrew` — дата письма целиком на иврите
6. `day_hebrew` — день на иврите (א, כא...)
7. `month_hebrew` — месяц на иврите
8. `year_hebrew` — год на иврите (תרפח, תרצב...)
9. `year_number` — год цифрой (5688, 5692...)
10. `url` — ссылка на письмо
11. `content` — текст письма
12. `date_parsed` — признак успешного парсинга даты

### Таблица `volumes`
- `volume_number`, `volume_hebrew`, `total_letters`, `total_pages`
- Рекомендуемые дополнительные поля: `first_letter_number`, `last_letter_number`

## 🎯 Логика парсинга

### Навигация по томам
- С главной страницы томов найти ссылки вида «כרך X»
- Перейти на страницу тома

### Поиск писем в томе
- На странице тома собрать ссылки `/aid/NNNNNN/jewish/page.htm` в пределах диапазона писем
- Обход постранично `?page=N`

### Парсинг письма
- Номер письма из заголовка «מכתב [буква]» → `letter_hebrew` и `letter_number`
- Дата из первой строки текста → разбить на компоненты
- Сохранить в Supabase (upsert по уникальному `(volume_id, letter_number)`)

### Возобновление (resume)
- Перед стартом запросить последнюю сохранённую запись из `letters` данного тома (по `created_at`)
- Найти её URL в списке ссылок и продолжить со следующей, чтобы избежать дублей

## 📈 Ожидаемые результаты
- Для тома א: ~169 писем на 4 страницах
- Для каждого тома сохранить `total_letters`, `total_pages`, `first_letter_number`, `last_letter_number`

## 🚨 Критические моменты
1. Парсить только реальные страницы писем (не блоги/сервисы)
2. Дата всегда ищется в первой строке
3. Все отчёты и данные для пользователя — на иврите
4. Логи, сообщения и HTML-отчёты — на иврите
5. Резюме-парсинг без дублей (продолжать со следующего письма)

